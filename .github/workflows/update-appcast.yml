name: Update Sparkle Appcast

on:
  release:
    types: [published, edited]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (for example: v1.2.3). Leave empty to use latest release."
        required: false
        type: string

permissions:
  contents: write

jobs:
  appcast:
    runs-on: macos-15
    env:
      SPARKLE_VERSION: "2.8.1"
    steps:
      - name: Resolve release and select archive
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_RELEASE_TAG: ${{ github.event.inputs.release_tag }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_RELEASE_URL: ${{ github.event.release.url }}
        run: |
          set -euo pipefail

          if [ "$EVENT_NAME" = "release" ] && [ -n "${EVENT_RELEASE_URL:-}" ]; then
            release_json="$(gh api "$EVENT_RELEASE_URL")"
          elif [ -n "${INPUT_RELEASE_TAG:-}" ]; then
            release_json="$(gh api "repos/$GITHUB_REPOSITORY/releases/tags/$INPUT_RELEASE_TAG")"
          else
            release_json="$(gh api "repos/$GITHUB_REPOSITORY/releases/latest")"
          fi

          tag_name="$(echo "$release_json" | jq -r '.tag_name')"
          release_id="$(echo "$release_json" | jq -r '.id')"

          archive_name="$(
            echo "$release_json" \
              | jq -r '
                .assets
                | map(select(.name | endswith(".zip")))
                | sort_by(.updated_at)
                | last
                | .name // empty
              '
          )"

          if [ -z "$archive_name" ]; then
            echo "No .zip release asset found."
            echo "Upload your signed ZIP first, then rerun this workflow."
            exit 1
          fi

          mkdir -p artifacts
          gh release download "$tag_name" \
            --repo "$GITHUB_REPOSITORY" \
            --pattern "$archive_name" \
            --dir artifacts

          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"
          echo "release_id=$release_id" >> "$GITHUB_OUTPUT"
          echo "archive_name=$archive_name" >> "$GITHUB_OUTPUT"

      - name: Install Sparkle tools
        run: |
          set -euo pipefail
          curl -fL --retry 3 --retry-delay 2 \
            -o sparkle.tar.xz \
            "https://github.com/sparkle-project/Sparkle/releases/download/$SPARKLE_VERSION/Sparkle-$SPARKLE_VERSION.tar.xz"
          tar -xJf sparkle.tar.xz
          generate_appcast_path="$(find . -type f -path "*/bin/generate_appcast" | head -n 1)"
          if [ -z "$generate_appcast_path" ]; then
            echo "Could not find generate_appcast in Sparkle distribution."
            exit 1
          fi
          chmod +x "$generate_appcast_path"
          echo "GENERATE_APPCAST=$generate_appcast_path" >> "$GITHUB_ENV"

      - name: Generate appcast.xml
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
          TAG_NAME: ${{ steps.resolve.outputs.tag_name }}
          ARCHIVE_NAME: ${{ steps.resolve.outputs.archive_name }}
        run: |
          set -euo pipefail
          if [ -z "${SPARKLE_PRIVATE_KEY:-}" ]; then
            echo "Missing SPARKLE_PRIVATE_KEY secret."
            exit 1
          fi

          printf "%s" "$SPARKLE_PRIVATE_KEY" > sparkle_private_key
          chmod 600 sparkle_private_key

          "$GENERATE_APPCAST" \
            --ed-key-file sparkle_private_key \
            artifacts

          if [ ! -f artifacts/appcast.xml ]; then
            echo "generate_appcast did not produce artifacts/appcast.xml"
            exit 1
          fi

          python3 - <<'PY'
          from pathlib import Path
          import xml.etree.ElementTree as ET
          import os

          appcast_path = Path("artifacts/appcast.xml")
          tree = ET.parse(appcast_path)
          root = tree.getroot()

          archive_name = os.environ["ARCHIVE_NAME"]
          tag_name = os.environ["TAG_NAME"]
          repo = os.environ["GITHUB_REPOSITORY"]
          download_url = f"https://github.com/{repo}/releases/download/{tag_name}/{archive_name}"

          for enclosure in root.findall(".//enclosure"):
              enclosure.set("url", download_url)

          tree.write(appcast_path, encoding="utf-8", xml_declaration=True)
          PY

      - name: Upload appcast.xml to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.resolve.outputs.tag_name }}
        run: |
          set -euo pipefail
          gh release upload "$TAG_NAME" artifacts/appcast.xml --clobber --repo "$GITHUB_REPOSITORY"

      - name: Update Homebrew tap cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.resolve.outputs.tag_name }}
          ARCHIVE_NAME: ${{ steps.resolve.outputs.archive_name }}
          TAP_REPOSITORY: vizzly-testing/homebrew-tap
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "Missing HOMEBREW_TAP_GITHUB_TOKEN secret."
            exit 1
          fi

          archive_path="artifacts/$ARCHIVE_NAME"
          if [ ! -f "$archive_path" ]; then
            echo "Expected release archive not found at $archive_path"
            exit 1
          fi

          python3 - <<'PY'
          import hashlib
          import os
          from pathlib import Path

          version = os.environ["TAG_NAME"].removeprefix("v")
          archive_name = os.environ["ARCHIVE_NAME"]
          archive_path = Path("artifacts") / archive_name
          sha256 = hashlib.sha256(archive_path.read_bytes()).hexdigest()

          lines = [
              'cask "vizzly" do',
              f'  version "{version}"',
              f'  sha256 "{sha256}"',
              "",
              f'  url "https://github.com/vizzly-testing/menubar/releases/download/v#{{version}}/{archive_name}",',
              '      verified: "github.com/vizzly-testing/menubar/"',
              '  name "Vizzly"',
              '  desc "Native macOS menubar app for managing Vizzly TDD servers"',
              '  homepage "https://github.com/vizzly-testing/menubar"',
              "",
              '  app "Vizzly.app"',
              "end",
              "",
          ]
          Path("vizzly.rb").write_text("\n".join(lines), encoding="utf-8")
          PY

          content="$(base64 < vizzly.rb | tr -d '\n')"
          existing_sha="$(
            gh api "repos/$TAP_REPOSITORY/contents/Casks/vizzly.rb" --jq '.sha' 2>/dev/null || true
          )"

          if [ -n "$existing_sha" ]; then
            gh api "repos/$TAP_REPOSITORY/contents/Casks/vizzly.rb" \
              -X PUT \
              -f message="üç∫ Update vizzly cask to $TAG_NAME" \
              -f content="$content" \
              -f sha="$existing_sha"
          else
            gh api "repos/$TAP_REPOSITORY/contents/Casks/vizzly.rb" \
              -X PUT \
              -f message="üç∫ Add vizzly cask for $TAG_NAME" \
              -f content="$content"
          fi
